<script>
/* ----------------- Helpers ----------------- */
function qp(key) {
  return new URLSearchParams(location.search).get(key) || "";
}
function toISODate(d) {
  const tz = d.getTimezoneOffset() * 60000;
  return new Date(d.getTime() - tz).toISOString().slice(0, 10);
}
function parseISODate(s) {
  const [y, m, d] = s.split("-").map(Number);
  return new Date(y, m - 1, d);
}
function weekdayKeyFromDateStr(iso) {
  return ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][
    parseISODate(iso).getDay()
  ];
}

/* ----------------- DAY NORMALIZER ----------------- */
function normalizeDayToAbbrev(token) {
  if (!token) return "";
  const t = token.toString().trim().toLowerCase();
  const map = {
    sun: "Sun", sunday: "Sun",
    mon: "Mon", monday: "Mon",
    tue: "Tue", tues: "Tue", tuesday: "Tue",
    wed: "Wed", weds: "Wed", wednesday: "Wed",
    thu: "Thu", thur: "Thu", thurs: "Thu", thursday: "Thu",
    fri: "Fri", friday: "Fri",
    sat: "Sat", saturday: "Sat",
  };
  return map[t] || map[t.slice(0, 3)] || "";
}

/* ----------------- FETCH TRAINERS ONLY /api/trainers ----------------- */
async function fetchTrainers() {
  const r = await fetch("/api/trainers", {
    headers: { Accept: "application/json" },
  });

  if (!r.ok) throw new Error(`/api/trainers â†’ ${r.status}`);
  return r.json();
}

/* ----------------- BUILD WEEK SCHEDULE ----------------- */
function buildWeekSchedule(trainer) {
  const sched = {};
  if (!trainer) return sched;

  let raw = trainer.schedule;
  let arr = [];

  if (Array.isArray(raw)) arr = raw;
  else if (typeof raw === "string") {
    try {
      arr = JSON.parse(raw);
    } catch {
      console.warn("Invalid schedule JSON string", raw);
      arr = [];
    }
  }

  arr.forEach((slotRaw) => {
    if (typeof slotRaw !== "string") return;

    let s = slotRaw.replace(/\u2013/g, "-").replace(/\s+/g, " ").trim();

    const m = s.match(/^([A-Za-z]+)\s+([0-2]\d:[0-5]\d)\s*-\s*([0-2]\d:[0-5]\d)$/);
    if (!m) return;

    const dayAbbrev = normalizeDayToAbbrev(m[1]);
    if (!dayAbbrev) return;

    const timeStr = `${m[2]}-${m[3]}`;
    if (!sched[dayAbbrev]) sched[dayAbbrev] = [];
    sched[dayAbbrev].push(timeStr);
  });

  return sched;
}

/* ----------------- SCHEDULE TO UI ----------------- */
function refreshTimeOptionsForDate(sched, isoDate) {
  const timeSel = document.getElementById("timeSlot");
  const note = document.getElementById("scheduleNote");
  const btn = document.getElementById("bookBtn");

  timeSel.innerHTML = '<option value="">Choose a time</option>';

  if (!isoDate) {
    note.textContent = "Please pick a date.";
    btn.disabled = true;
    return;
  }

  const wk = weekdayKeyFromDateStr(isoDate);
  const slots = sched[wk] || [];

  if (slots.length) {
    slots.forEach((t) => {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      timeSel.appendChild(opt);
    });
    note.textContent = `Available on ${wk}: ${slots.join(", ")}`;
    btn.disabled = false;
  } else {
    note.textContent = `No classes on this day.`;
    btn.disabled = true;
  }
}

function getFirstAvailableDate(sched, maxDays = 90) {
  const today = new Date();
  for (let i = 0; i < maxDays; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() + i);
    const iso = toISODate(d);
    const wk = weekdayKeyFromDateStr(iso);
    if (sched[wk] && sched[wk].length) return iso;
  }
  return "";
}

/* ----------------- MAIN INIT ----------------- */
async function loadScheduleAndRefresh(trainerName, preferredISO, preferredTime) {
  let sched = {};

  try {
    const trainers = await fetchTrainers();
    const trainer = trainers.find((t) => t.name === trainerName);
    sched = buildWeekSchedule(trainer);
  } catch (e) {
    console.error(e);
    sched = {};
  }

  let defaultISO = preferredISO;
  if (defaultISO) {
    const wk = weekdayKeyFromDateStr(defaultISO);
    if (!sched[wk] || !sched[wk].length) defaultISO = "";
  }
  if (!defaultISO) defaultISO = getFirstAvailableDate(sched, 90);

  const dateInput = document.getElementById("date");
  dateInput.value = defaultISO || "";

  refreshTimeOptionsForDate(sched, dateInput.value);

  if (preferredTime) {
    const sel = document.getElementById("timeSlot");
    const has = Array.from(sel.options).some((o) => o.value === preferredTime);
    if (has) sel.value = preferredTime;
  }

  dateInput.onchange = (e) => {
    refreshTimeOptionsForDate(sched, e.target.value);
  };
}

/* ----------------- INIT DOM ----------------- */
document.addEventListener("DOMContentLoaded", async () => {
  const trainerSelect = document.getElementById("trainer");

  let trainerName = qp("trainer");
  let className = qp("class");
  let price = qp("price");
  let dateQ = qp("date");
  let timeQ = qp("time");
  let classId = qp("classId");

  if (trainerName) {
    const opt = Array.from(trainerSelect.options).find(
      (o) => o.value === trainerName
    );
    if (opt) {
      trainerSelect.value = trainerName;
      document.getElementById("trainerId").value =
        opt.getAttribute("data-id") || "";
    }
  }

  document.getElementById("class").value = className || "";
  document.getElementById("price").value = price || "";
  document.getElementById("classId").value = classId || "";

  trainerSelect.addEventListener("change", async (e) => {
    const opt = e.target.selectedOptions[0];
    document.getElementById("trainerId").value =
      opt.getAttribute("data-id") || "";
    await loadScheduleAndRefresh(opt.value, "", "");
    document.getElementById("timeSlot").value = "";
  });

  await loadScheduleAndRefresh(trainerName, dateQ, timeQ);
});
</script>
